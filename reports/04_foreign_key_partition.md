# 外部キーパーティション 比較レポート

## 概要

外部キー（author_id）でパーティションを分割した場合の効果を検証。

**注意**: MySQL のパーティションテーブルでは外部キー制約は使用できないため、
アプリケーション側での整合性管理が必要。

---

## テスト条件

- レコード数: **1,000,000件** (books), **100,000件** (authors)
- 比較対象:
  - パーティションなし（インデックスあり）
  - HASH(author_id) 8分割
  - RANGE(author_id) 10分割（10,000件ごと）

---

## 1. 単一著者検索

特定の著者（author_id = 500）の本を検索。

| 構成 | 時間 | 比較 |
|------|------|------|
| パーティションなし | 82µs | baseline |
| **HASH(author_id)** | **51µs** | **37% 高速** |
| RANGE(author_id) | 482µs | 487% 低速 |

### 分析
- **HASH が最速**: パーティションプルーニングが効く
- RANGE は不向き: author_id の分布が偏ると効果が薄い

---

## 2. 著者範囲検索（1000人分）

author_id BETWEEN 500 AND 1500 の本を検索（約10万件）。

| 構成 | 時間 | 比較 |
|------|------|------|
| パーティションなし | 49.0ms | baseline |
| HASH(author_id) | 14.6ms | 70% 高速 |
| **RANGE(author_id)** | **11.1ms** | **77% 高速** |

### 分析
- **RANGE が最速**: 範囲検索ではパーティションプルーニングが効果的
- HASH も高速だが、RANGE には及ばない

---

## 3. JOIN クエリ（著者 + 本）

author_id BETWEEN 500 AND 600 の著者と本を JOIN。

| 構成 | 時間 | 比較 |
|------|------|------|
| パーティションなし | 1.57ms | baseline |
| HASH(author_id) | 1.63ms | 4% 低速 |
| RANGE(author_id) | 1.81ms | 15% 低速 |

### 分析
- JOIN ではパーティションのオーバーヘッドが発生
- パーティションをまたぐ JOIN は避けるべき

---

## 4. 大量データでの検証（10,000,000件）

| クエリ | パーティションなし | HASH | RANGE |
|-------|------------------|------|-------|
| 単一著者 | 1.1ms | - | **0.2ms** |
| 範囲検索 | 5.4ms | - | **0.3ms** |

### 分析
- 大量データでは RANGE の効果が顕著
- 10倍以上の高速化

---

## 推奨パーティション戦略

### 単一値検索が多い場合
```sql
PARTITION BY HASH(author_id) PARTITIONS 8;
```

### 範囲検索が多い場合
```sql
PARTITION BY RANGE (author_id) (
    PARTITION p0 VALUES LESS THAN (10000),
    PARTITION p1 VALUES LESS THAN (20000),
    ...
);
```

### 両方のケースがある場合
- インデックスのみで対応
- または RANGE パーティション（範囲検索がより高速）

---

## 注意点

### 1. 外部キー制約は使用不可
```sql
-- これはエラーになる
CREATE TABLE books (
    ...
    FOREIGN KEY (author_id) REFERENCES authors(id)
) PARTITION BY HASH(author_id);
```

### 2. パーティションキーは PRIMARY KEY に含める必要
```sql
-- author_id を PRIMARY KEY に含める
PRIMARY KEY (id, author_id)
```

### 3. アプリケーション側での整合性管理
- 参照整合性はアプリケーションで担保
- または定期的なバッチチェック

---

## まとめ

| ユースケース | 推奨パーティション | 効果 |
|-------------|------------------|------|
| 単一著者検索 | HASH | 37% 高速 |
| 著者範囲検索 | **RANGE** | **77% 高速** |
| JOIN | なし（インデックスのみ） | - |
