# MySQL パーティション実験 概要レポート

## 実験の目的

MySQL のパーティション機能について、以下を検証する:

1. **インデックスとパーティションの比較**: どちらがより効果的か？
2. **パーティション種類の比較**: HASH, RANGE, LIST, KEY の使い分け
3. **パーティション数の影響**: 最適なパーティション数は？
4. **実運用での注意点**: パーティションが逆効果になるケース

## 実験環境

- MySQL 8.0
- Docker コンテナ (ローカル環境)
- Go 1.25

### MySQL 設定値

| 設定 | 値 |
|------|-----|
| innodb_buffer_pool_size | 512MB |
| innodb_log_file_size | 256MB |
| max_allowed_packet | 256MB |
| character_set_server | utf8mb4 |

### 測定上の注意

本検証の測定には以下の制約がある:

- **単一回測定**: 各クエリは原則1回のみ測定。複数回測定による平均・標準偏差は取得していない
- **キャッシュの影響**: 測定前のキャッシュ状態（バッファプールのウォームアップ状態）が統一されていない可能性がある
- **統計的有意性**: マイクロ秒単位の差については、測定誤差の範囲内である可能性がある

これらの制約により、特に小さな差（10%未満の改善など）については参考値として扱うべき。

## テストデータ

| テーブル | レコード数 | 用途 |
|---------|-----------|------|
| books | 1,000,000〜10,000,000 | メインテスト対象 |
| authors | 100,000〜10,000,000 | 外部キー参照元 |
| book_tags | 1,000,000〜50,000,000 | 中間テーブル |
| tags | 1,000 | マスタデータ |

## テストパターン

### 1. インデックス vs パーティション
- インデックスなし・パーティションなし
- インデックスあり・パーティションなし
- インデックスなし・パーティションあり
- インデックスあり・パーティションあり

### 2. パーティション種類
- HASH (id)
- RANGE (created_at / year)
- RANGE (id)
- RANGE (author_id / 外部キー)
- LIST (status)
- KEY (複合キー)

### 3. パーティション数
- 8 パーティション
- 100 パーティション
- 1,000 パーティション
- 8,000 パーティション

## レポート一覧

1. [インデックス vs パーティション比較](02_index_vs_partition.md)
2. [パーティション種類別比較](03_partition_types.md)
3. [外部キーパーティション](04_foreign_key_partition.md)
4. [パーティション数の影響](05_partition_count.md)
5. [結論と推奨事項](06_conclusion.md)

---

## 主要な発見（サマリー）

### インデックス vs パーティション

| 構成 | 日付範囲検索 | PK検索 | COUNT(*) |
|------|------------|--------|----------|
| なし | baseline | baseline | **最速** |
| インデックスのみ | **99.8%削減** | **99.9%削減** | 10倍遅い |
| パーティションのみ | 93.7%削減 | 6%削減 | 10倍遅い |
| **両方** | **99.8%削減** | **99.99%削減** | **16倍遅い** |

**結論**: インデックスが最重要。パーティションは追加の最適化手段。

### パーティション数の影響

| パーティション数 | 範囲検索 | INSERT(10M件) |
|-----------------|---------|---------------|
| 8 | **最速** | 数分 |
| 100 | 5倍遅い | 数分 |
| 1,000 | 7倍遅い | 十数分 |
| 8,000 | **304倍遅い** | **70分以上** |

**結論**: パーティション数は 8〜100 が最適。1000以上は避ける。

### パーティション種類の使い分け

| 種類 | 最適なユースケース | 避けるべきケース |
|------|------------------|----------------|
| HASH | PK検索、均等分散 | 範囲検索 |
| RANGE(日付) | 時系列データ、ログ削除 | GROUP BY |
| RANGE(ID) | アーカイブ | - |
| LIST | マルチテナント | 多値ステータス |
| KEY | 複合キー検索 | 部分キー検索 |
